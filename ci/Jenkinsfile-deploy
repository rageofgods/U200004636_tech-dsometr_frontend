def BUILD_ENVIRONMENT = ""
def DEPLOY_ENVIRONMENT = ""
def RH_REGISTRY = ""
def RH_REGISTRY_CRED_ID = ""
def REGISTRY = ""
def REGISTRY_CRED_ID = ""
def OCP_URL_TARGET = ""
def OCP_CRED_ID = ""
def OCP_NAMESPACE = ""
def OCP_APP_NAME = ""           
def OCP_IMAGE_STREAM = ""
def OCP_TEMPLATE_NAME = ""
def GIT_BASE_URL = ""
def GIT_CRED_ID = ""
def DOCKER_FILE_NAME = ""
def DOCKER_BUILD_NAME = ""

withFolderProperties{
    def BUILD_ENVIRONMENT = "${env.BUILD_ENVIRONMENT}"
    def DEPLOY_ENVIRONMENT = "${env.DEPLOY_ENVIRONMENT}"
    def RH_REGISTRY = "${env.RH_REGISTRY}"
    def RH_REGISTRY_CRED_ID = "${env.RH_REGISTRY_CRED_ID}"
    def REGISTRY = "${env.REGISTRY}"
    def REGISTRY_CRED_ID = "${env.REGISTRY_CRED_ID}"
    def OCP_URL_TARGET = "${env.OCP_URL_TARGET}"
    def OCP_CRED_ID = "${env.OCP_CRED_ID}"
    def OCP_NAMESPACE = "${env.OCP_NAMESPACE}"
    def OCP_APP_NAME = "${env.OCP_APP_NAME}"       
    def OCP_IMAGE_STREAM = "${env.OCP_IMAGE_STREAM}"
    def OCP_TEMPLATE_NAME = "${env.OCP_TEMPLATE_NAME}"
    def GIT_BASE_URL = "${env.GIT_BASE_URL}"
    def GIT_CRED_ID = "${env.GIT_CRED_ID}"
    def DOCKER_FILE_NAME = "${env.DOCKER_FILE_NAME}"
    def DOCKER_BUILD_NAME = "${env.DOCKER_BUILD_NAME}"
}

if (BUILD_ENVIRONMENT == '' || BUILD_ENVIRONMENT == null || BUILD_ENVIRONMENT == 'null') {
    currentBuild.result = 'ABORTED'
    error('Not defined BUILD_ENVIRONMENT in Folder properies plugin!')
}

pipeline {
    agent any

    environment {
        BUILD_ENVIRONMENT = "${BUILD_ENVIRONMENT}"
        DEPLOY_ENVIRONMENT = "${DEPLOY_ENVIRONMENT}"
        RH_REGISTRY = "${RH_REGISTRY}"
        RH_REGISTRY_CRED_ID = "${RH_REGISTRY_CRED_ID}"
        REGISTRY = "${REGISTRY}"
        REGISTRY_CRED_ID = "${REGISTRY_CRED_ID}"
        OCP_URL_TARGET = "${OCP_URL_TARGET}"
        OCP_CRED_ID = "${OCP_CRED_ID}"
        OCP_NAMESPACE = "${OCP_NAMESPACE}"
        OCP_APP_NAME = "${OCP_APP_NAME}"       
        OCP_IMAGE_STREAM = "${OCP_IMAGE_STREAM}"
        OCP_TEMPLATE_NAME = "${OCP_TEMPLATE_NAME}"
        GIT_BASE_URL = "${GIT_BASE_URL}"
        GIT_CRED_ID = "${GIT_CRED_ID}"
        DOCKER_FILE_NAME = "${DOCKER_FILE_NAME}"
        DOCKER_BUILD_NAME = "${OCP_APP_NAME}" //docker build name = ocp app name
        GIT_COMMIT_SHORT = sh(
            script: "printf \$(git rev-parse --short ${GIT_COMMIT})",
            returnStdout: true
        )
    }
    stages {
        stage("Docker registry login") {
            steps {
                echo "=====docker login registry====="
                withCredentials([usernamePassword(credentialsId: "$REGISTRY_CRED_ID", usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                    sh """
                    docker login $RH_REGISTRY -u $USERNAME -p $PASSWORD
                    docker login $REGISTRY -u $USERNAME -p $PASSWORD
                    """
                }
            }
        }
        stage("Docker build image") {
            steps {
                echo "=====docker login and build====="
                sh """
                docker build -t $REGISTRY/$DOCKER_BUILD_NAME:$GIT_COMMIT_SHORT -f $DOCKER_FILE_NAME .
                """
            }
        }
        stage("Docker push image") {
            steps {
                echo "=====docker login and push====="
                sh """
                docker push $REGISTRY/$DOCKER_BUILD_NAME:$GIT_COMMIT_SHORT
                """
            }
        }
    }
}